<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stretch Studio Manager</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--tg-theme-bg-color, #ffffff); color: var(--tg-theme-text-color, #000000); padding: 0; margin: 0; overflow-x: hidden; }
        .header { background: var(--tg-theme-secondary-bg-color, #f4f4f5); padding: 12px 16px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--tg-theme-hint-color, #e5e5e5); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 18px; font-weight: 600; color: var(--tg-theme-text-color, #000000); }
        .lang-switch { background: var(--tg-theme-button-color, #3390ec); color: var(--tg-theme-button-text-color, #ffffff); border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .tabs { display: flex; background: var(--tg-theme-secondary-bg-color, #f4f4f5); border-bottom: 1px solid var(--tg-theme-hint-color, #e5e5e5); overflow-x: auto; position: sticky; top: 45px; z-index: 99; -webkit-overflow-scrolling: touch; }
        .tab-button { flex: 0 0 auto; padding: 12px 16px; background: transparent; border: none; color: var(--tg-theme-hint-color, #999999); font-size: 14px; font-weight: 500; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; }
        .tab-button.active { color: var(--tg-theme-button-color, #3390ec); border-bottom-color: var(--tg-theme-button-color, #3390ec); }
        .content { padding: 12px; padding-bottom: 80px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: var(--tg-theme-secondary-bg-color, #ffffff); border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .section-title { font-size: 18px; font-weight: 600; margin-bottom: 12px; color: var(--tg-theme-text-color, #000000); }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px; }
        .stat-card { background: var(--tg-theme-bg-color, #ffffff); padding: 12px; border-radius: 8px; border: 1px solid var(--tg-theme-hint-color, #e5e5e5); }
        .stat-value { font-size: 24px; font-weight: 700; color: var(--tg-theme-button-color, #3390ec); margin-bottom: 4px; }
        .stat-label { font-size: 12px; color: var(--tg-theme-hint-color, #999999); }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 6px; color: var(--tg-theme-text-color, #000000); }
        .input-field { width: 100%; padding: 12px; border: 1px solid var(--tg-theme-hint-color, #e5e5e5); border-radius: 8px; font-size: 16px; background: var(--tg-theme-bg-color, #ffffff); color: var(--tg-theme-text-color, #000000); }
        .input-field:focus { outline: none; border-color: var(--tg-theme-button-color, #3390ec); }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        .btn:active { opacity: 0.7; }
        .btn-primary { background: var(--tg-theme-button-color, #3390ec); color: var(--tg-theme-button-text-color, #ffffff); }
        .btn-secondary { background: var(--tg-theme-secondary-bg-color, #f4f4f5); color: var(--tg-theme-text-color, #000000); border: 1px solid var(--tg-theme-hint-color, #e5e5e5); }
        .session-item { background: var(--tg-theme-bg-color, #ffffff); padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--tg-theme-hint-color, #e5e5e5); }
        .session-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; }
        .session-title { font-size: 16px; font-weight: 600; color: var(--tg-theme-text-color, #000000); }
        .session-amount { font-size: 18px; font-weight: 700; color: var(--tg-theme-button-color, #3390ec); }
        .session-info { font-size: 13px; color: var(--tg-theme-hint-color, #999999); line-height: 1.5; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-right: 4px; margin-bottom: 4px; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-group { background: #e7f3ff; color: #0066cc; }
        .badge-individual { background: #ffe7f3; color: #cc0066; }
        .studio-item { background: var(--tg-theme-bg-color, #ffffff); padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--tg-theme-hint-color, #e5e5e5); border-left: 4px solid; }
        .studio-name { font-size: 16px; font-weight: 600; margin-bottom: 8px; color: var(--tg-theme-text-color, #000000); }
        .studio-info { font-size: 13px; color: var(--tg-theme-hint-color, #999999); line-height: 1.6; }
        .action-buttons { display: flex; gap: 8px; margin-top: 8px; }
        .icon-btn { flex: 1; padding: 10px; border: 1px solid var(--tg-theme-hint-color, #e5e5e5); border-radius: 8px; background: var(--tg-theme-secondary-bg-color, #f4f4f5); color: var(--tg-theme-text-color, #000000); font-size: 14px; cursor: pointer; }
        .icon-btn:active { opacity: 0.7; }
        .icon-btn.danger { color: #dc3545; border-color: #dc3545; }
        .filter-section { background: var(--tg-theme-secondary-bg-color, #f4f4f5); padding: 12px; border-radius: 8px; margin-bottom: 12px; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--tg-theme-hint-color, #999999); }
        .empty-state-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
        .payment-preview { background: var(--tg-theme-button-color, #3390ec); color: var(--tg-theme-button-text-color, #ffffff); padding: 16px; border-radius: 8px; margin: 12px 0; }
        .payment-preview-amount { font-size: 32px; font-weight: 700; margin-bottom: 8px; }
        .payment-preview-text { font-size: 13px; opacity: 0.9; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--tg-theme-bg-color, #ffffff); z-index: 1000; display: none; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .modal.active { display: block; }
        .modal-header { position: sticky; top: 0; background: var(--tg-theme-secondary-bg-color, #f4f4f5); padding: 12px 16px; border-bottom: 1px solid var(--tg-theme-hint-color, #e5e5e5); display: flex; justify-content: space-between; align-items: center; z-index: 1001; }
        .modal-title { font-size: 18px; font-weight: 600; color: var(--tg-theme-text-color, #000000); }
        .close-btn { background: none; border: none; font-size: 24px; color: var(--tg-theme-hint-color, #999999); cursor: pointer; padding: 0; width: 32px; height: 32px; }
        .modal-content { padding: 16px; padding-bottom: 80px; }
        .info-box { background: #e7f3ff; padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #0066cc; }
        .info-box-text { font-size: 13px; color: #0066cc; line-height: 1.5; }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="appTitle">üèãÔ∏è Stretch Studio Manager</h1>
        <button class="lang-switch" onclick="toggleLanguage()" id="langBtn">RU</button>
    </div>

    <div class="tabs">
        <button class="tab-button active" onclick="showTab('dashboard')" data-lang-key="tabDashboard">üìä Dashboard</button>
        <button class="tab-button" onclick="showTab('statistics')" data-lang-key="tabStats">üìà Stats</button>
        <button class="tab-button" onclick="showTab('sessions')" data-lang-key="tabSessions">üèãÔ∏è Sessions</button>
        <button class="tab-button" onclick="showTab('studios')" data-lang-key="tabStudios">üè¢ Studios</button>
        <button class="tab-button" onclick="showTab('settings')" data-lang-key="tabSettings">‚öôÔ∏è Settings</button>
    </div>

    <div class="content">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid" id="dashboardStats"></div>
            <div class="card">
                <h2 class="section-title" data-lang-key="recentSessions">Recent Sessions</h2>
                <div id="recentSessions"></div>
            </div>
        </div>

        <!-- Statistics Tab -->
        <div id="statistics" class="tab-content">
            <div class="card">
                <h2 class="section-title" data-lang-key="filterStats">Filter Statistics</h2>
                <div class="filter-section">
                    <div class="form-group">
                        <label data-lang-key="labelStudio">Studio</label>
                        <select class="input-field" id="filterStudio">
                            <option value="" data-lang-key="allStudios">All Studios</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-lang-key="labelFromDate">From Date</label>
                        <input type="date" class="input-field" id="filterDateFrom">
                    </div>
                    <div class="form-group">
                        <label data-lang-key="labelToDate">To Date</label>
                        <input type="date" class="input-field" id="filterDateTo">
                    </div>
                    <button class="btn btn-primary" onclick="applyFilters()" data-lang-key="btnApplyFilters">üîç Apply Filters</button>
                </div>
            </div>
            <div class="card">
                <div class="stats-grid" id="filteredStats"></div>
            </div>
        </div>

        <!-- Sessions Tab -->
        <div id="sessions" class="tab-content">
            <div class="card">
                <button class="btn btn-primary" onclick="openSessionModal()" data-lang-key="btnAddSession">‚ûï Add Training Session</button>
            </div>
            <div id="sessionsList"></div>
        </div>

        <!-- Studios Tab -->
        <div id="studios" class="tab-content">
            <div class="card">
                <button class="btn btn-primary" onclick="openStudioModal()" data-lang-key="btnAddStudio">‚ûï Add New Studio</button>
            </div>
            <div id="studiosList"></div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="card">
                <h2 class="section-title" data-lang-key="settingsTitle">Settings & Backup</h2>
                
                <div class="info-box">
                    <div class="info-box-text" data-lang-key="storageInfo">
                        üì± Data stored on your phone. Use Export to backup your data.
                    </div>
                </div>

                <div class="form-group">
                    <button class="btn btn-primary" onclick="exportData()">
                        <span data-lang-key="btnExport">üì• Export Data</span>
                    </button>
                </div>
                
                <div class="form-group">
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                        <span data-lang-key="btnImport">üì§ Import Data</span>
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
                </div>
                
                <div class="form-group">
                    <button class="btn btn-secondary icon-btn danger" onclick="clearAllData()">
                        <span data-lang-key="btnClearAll">üóëÔ∏è Clear All Data</span>
                    </button>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label data-lang-key="dataStats">Data Statistics:</label>
                    <div id="dataStatsInfo" style="font-size: 13px; color: var(--tg-theme-hint-color); margin-top: 8px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Studio Modal -->
    <div id="studioModal" class="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="studioModalTitle" data-lang-key="modalAddStudio">Add Studio</h3>
            <button class="close-btn" onclick="closeStudioModal()">√ó</button>
        </div>
        <div class="modal-content">
            <form id="studioForm" onsubmit="saveStudio(event)">
                <input type="hidden" id="studioId">
                <div class="form-group">
                    <label data-lang-key="labelStudioName">Studio Name</label>
                    <input type="text" class="input-field" id="studioName" required>
                </div>
                <div class="form-group">
                    <label data-lang-key="labelMinPayment">Minimum Payment (‚Çæ)</label>
                    <input type="number" class="input-field" id="studioMinPayment" step="0.01" required>
                </div>
                <div class="form-group">
                    <label data-lang-key="labelPaymentPerClient">Payment Per Client (‚Çæ)</label>
                    <input type="number" class="input-field" id="studioPaymentPerClient" step="0.01" required>
                </div>
                <div class="form-group">
                    <label data-lang-key="labelStartCount">Start Count From</label>
                    <input type="number" class="input-field" id="studioStartCount" value="1" required>
                </div>
                <div class="form-group">
                    <label data-lang-key="labelIndividual">Individual Payment (‚Çæ)</label>
                    <input type="number" class="input-field" id="studioIndividual" step="0.01" value="0">
                </div>
                <div class="form-group">
                    <label data-lang-key="labelColor">Color</label>
                    <input type="color" class="input-field" id="studioColor" value="#3390ec" style="height: 50px;">
                </div>
                <button type="submit" class="btn btn-primary" data-lang-key="btnSave">üíæ Save</button>
            </form>
        </div>
    </div>

    <!-- Session Modal -->
    <div id="sessionModal" class="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="sessionModalTitle" data-lang-key="modalAddSession">Add Session</h3>
            <button class="close-btn" onclick="closeSessionModal()">√ó</button>
        </div>
        <div class="modal-content">
            <form id="sessionForm" onsubmit="saveSession(event)">
                <input type="hidden" id="sessionId">
                <div class="form-group">
                    <label data-lang-key="labelStudio">Studio</label>
                    <select class="input-field" id="sessionStudio" required></select>
                </div>
                <div class="form-group">
                    <label data-lang-key="labelSessionType">Session Type</label>
                    <select class="input-field" id="sessionType" onchange="toggleClientsField()">
                        <option value="group" data-lang-key="optionGroup">üë• Group</option>
                        <option value="individual" data-lang-key="optionIndividual">üë§ Individual</option>
                    </select>
                </div>
                <div class="form-group">
                    <label data-lang-key="labelDate">Date</label>
                    <input type="date" class="input-field" id="sessionDate" required>
                </div>
                <div class="form-group">
                    <label data-lang-key="labelTime">Time</label>
                    <input type="time" class="input-field" id="sessionTime" required>
                </div>
                <div class="form-group" id="clientsGroup">
                    <label data-lang-key="labelClients">Number of Clients</label>
                    <input type="number" class="input-field" id="sessionClients" min="1" value="1" onchange="updatePaymentPreview()">
                </div>
                <div class="form-group">
                    <label data-lang-key="labelCoach">Coach Name</label>
                    <input type="text" class="input-field" id="sessionCoach" required>
                </div>
                <div id="paymentPreview" style="display: none;"></div>
                <button type="submit" class="btn btn-primary" data-lang-key="btnSave">üíæ Save</button>
            </form>
        </div>
    </div>

    <script>
        // Telegram WebApp
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // Using localStorage - no user ID needed, data stays on phone!
        console.log('üì± Phone storage mode - data saved locally');

        // Translations (keeping your exact translations)
        const translations = {
            en: {
                appTitle: 'Stretch Studio Manager',
                tabDashboard: 'üìä Dashboard',
                tabStats: 'üìà Stats',
                tabSessions: 'üèãÔ∏è Sessions',
                tabStudios: 'üè¢ Studios',
                tabSettings: '‚öôÔ∏è Settings',
                recentSessions: 'Recent Sessions',
                filterStats: 'Filter Statistics',
                labelStudio: 'Studio',
                allStudios: 'All Studios',
                labelFromDate: 'From Date',
                labelToDate: 'To Date',
                btnApplyFilters: 'üîç Apply Filters',
                btnAddSession: '‚ûï Add Training Session',
                btnAddStudio: '‚ûï Add New Studio',
                modalAddStudio: 'Add Studio',
                modalEditStudio: 'Edit Studio',
                modalAddSession: 'Add Session',
                modalEditSession: 'Edit Session',
                labelStudioName: 'Studio Name',
                labelMinPayment: 'Minimum Payment (‚Çæ)',
                labelPaymentPerClient: 'Payment Per Client (‚Çæ)',
                labelStartCount: 'Start Count From',
                labelIndividual: 'Individual Payment (‚Çæ)',
                labelColor: 'Color',
                labelSessionType: 'Session Type',
                labelDate: 'Date',
                labelTime: 'Time',
                labelClients: 'Number of Clients',
                labelCoach: 'Coach Name',
                btnSave: 'üíæ Save',
                btnEdit: '‚úèÔ∏è Edit',
                btnDelete: 'üóëÔ∏è Delete',
                btnMarkPaid: '‚úì Mark Paid',
                optionGroup: 'üë• Group',
                optionIndividual: 'üë§ Individual',
                statSessions: 'Total Sessions',
                statAttendees: 'Total Attendees',
                statPaid: 'Paid',
                statPending: 'Pending',
                settingsTitle: 'Settings & Backup',
                storageInfo: 'üì± Data stored on your phone. Use Export to backup your data.',
                btnExport: 'üì• Export Data',
                btnImport: 'üì§ Import Data',
                btnClearAll: 'üóëÔ∏è Clear All Data',
                dataStats: 'Data Statistics:',
                emptyStudios: 'No studios yet. Add your first studio!',
                emptySessions: 'No sessions yet. Add your first session!',
                confirmDelete: 'Are you sure you want to delete this?',
                confirmClearAll: 'Delete ALL data? This cannot be undone!',
                exportSuccess: 'Data exported successfully!',
                importSuccess: 'Data imported successfully!',
                clearSuccess: 'All data cleared!',
                studioSaved: 'Studio saved!',
                sessionSaved: 'Session saved!',
                payment: 'Payment',
                paid: 'Paid',
                pending: 'Pending',
                clients: 'clients',
                group: 'Group',
                individual: 'Individual',
                at: 'at'
            },
            ru: {
                appTitle: '–ú–µ–Ω–µ–¥–∂–µ—Ä –°—Ç—É–¥–∏–∏',
                tabDashboard: 'üìä –ü–∞–Ω–µ–ª—å',
                tabStats: 'üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
                tabSessions: 'üèãÔ∏è –°–µ—Å—Å–∏–∏',
                tabStudios: 'üè¢ –°—Ç—É–¥–∏–∏',
                tabSettings: '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏',
                recentSessions: '–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–µ—Å—Å–∏–∏',
                filterStats: '–§–∏–ª—å—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏',
                labelStudio: '–°—Ç—É–¥–∏—è',
                allStudios: '–í—Å–µ —Å—Ç—É–¥–∏–∏',
                labelFromDate: '–° –¥–∞—Ç—ã',
                labelToDate: '–ü–æ –¥–∞—Ç—É',
                btnApplyFilters: 'üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã',
                btnAddSession: '‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Å—Å–∏—é',
                btnAddStudio: '‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–∏—é',
                modalAddStudio: '–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–∏—é',
                modalEditStudio: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—É–¥–∏—é',
                modalAddSession: '–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Å—Å–∏—é',
                modalEditSession: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Å—Å–∏—é',
                labelStudioName: '–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—É–¥–∏–∏',
                labelMinPayment: '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –æ–ø–ª–∞—Ç–∞ (‚Çæ)',
                labelPaymentPerClient: '–û–ø–ª–∞—Ç–∞ –∑–∞ –∫–ª–∏–µ–Ω—Ç–∞ (‚Çæ)',
                labelStartCount: '–ù–∞—á–∞—Ç—å —Å—á—ë—Ç —Å',
                labelIndividual: '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –æ–ø–ª–∞—Ç–∞ (‚Çæ)',
                labelColor: '–¶–≤–µ—Ç',
                labelSessionType: '–¢–∏–ø —Å–µ—Å—Å–∏–∏',
                labelDate: '–î–∞—Ç–∞',
                labelTime: '–í—Ä–µ–º—è',
                labelClients: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤',
                labelCoach: '–ò–º—è —Ç—Ä–µ–Ω–µ—Ä–∞',
                btnSave: 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
                btnEdit: '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å',
                btnDelete: 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å',
                btnMarkPaid: '‚úì –û–ø–ª–∞—á–µ–Ω–æ',
                optionGroup: 'üë• –ì—Ä—É–ø–ø–∞',
                optionIndividual: 'üë§ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ',
                statSessions: '–í—Å–µ–≥–æ —Å–µ—Å—Å–∏–π',
                statAttendees: '–í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤',
                statPaid: '–û–ø–ª–∞—á–µ–Ω–æ',
                statPending: '–û–∂–∏–¥–∞–µ—Ç',
                settingsTitle: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ',
                storageInfo: 'üì± –î–∞–Ω–Ω—ã–µ –Ω–∞ –≤–∞—à–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.',
                btnExport: 'üì• –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å',
                btnImport: 'üì§ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å',
                btnClearAll: 'üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë',
                dataStats: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö:',
                emptyStudios: '–ù–µ—Ç —Å—Ç—É–¥–∏–π. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —Å—Ç—É–¥–∏—é!',
                emptySessions: '–ù–µ—Ç —Å–µ—Å—Å–∏–π. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —Å–µ—Å—Å–∏—é!',
                confirmDelete: '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ?',
                confirmClearAll: '–£–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!',
                exportSuccess: '–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!',
                importSuccess: '–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!',
                clearSuccess: '–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã!',
                studioSaved: '–°—Ç—É–¥–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!',
                sessionSaved: '–°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!',
                payment: '–û–ø–ª–∞—Ç–∞',
                paid: '–û–ø–ª–∞—á–µ–Ω–æ',
                pending: '–û–∂–∏–¥–∞–µ—Ç',
                clients: '–∫–ª–∏–µ–Ω—Ç–æ–≤',
                group: '–ì—Ä—É–ø–ø–∞',
                individual: '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ',
                at: '–≤'
            }
        };

        let currentLang = localStorage.getItem('language') || (tg?.initDataUnsafe?.user?.language_code === 'ru' ? 'ru' : 'en');
        
        // Data - stored in localStorage
        let studios = [];
        let sessions = [];
        let stats = {};
        let filteredStats = {};

        // Helper function for translations
        function t(key) {
            return translations[currentLang][key] || key;
        }

        // Toggle language
        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ru' : 'en';
            localStorage.setItem('language', currentLang);
            updateLanguage();
            renderAll();
            if (tg) tg.HapticFeedback.impactOccurred('light');
        }

        // Update language in UI
        function updateLanguage() {
            document.getElementById('langBtn').textContent = currentLang.toUpperCase();
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (translations[currentLang][key]) {
                    if (el.tagName === 'OPTION' || el.tagName === 'BUTTON' || el.tagName === 'LABEL' || el.tagName === 'H1' || el.tagName === 'H2' || el.tagName === 'H3') {
                        el.textContent = translations[currentLang][key];
                    }
                }
            });
        }

        // localStorage functions
        function loadStudios() {
            return JSON.parse(localStorage.getItem('studios') || '[]');
        }

        function saveStudios(data) {
            localStorage.setItem('studios', JSON.stringify(data));
        }

        function loadSessions() {
            return JSON.parse(localStorage.getItem('sessions') || '[]');
        }

        function saveSessions(data) {
            localStorage.setItem('sessions', JSON.stringify(data));
        }

        // Load data
        function loadData() {
            studios = loadStudios();
            sessions = loadSessions();
            calculateStats();
            renderAll();
            updateDataStatsInfo();
        }

        // Calculate statistics
        function calculateStats() {
            const totalSessions = sessions.length;
            const paidSessions = sessions.filter(s => s.paid);
            const pendingSessions = sessions.filter(s => !s.paid);
            
            const paidRevenue = paidSessions.reduce((sum, s) => {
                const studio = studios.find(st => st.id === s.studioId);
                return sum + calculatePayment(s, studio);
            }, 0);
            
            const pendingRevenue = pendingSessions.reduce((sum, s) => {
                const studio = studios.find(st => st.id === s.studioId);
                return sum + calculatePayment(s, studio);
            }, 0);
            
            stats = {
                totalSessions,
                totalAttendees: sessions.reduce((sum, s) => sum + (s.numClients || 0), 0),
                paidRevenue,
                pendingRevenue
            };
        }

        // Calculate payment for a session
        function calculatePayment(session, studio) {
            if (!studio) return 0;
            
            if (session.sessionType === 'individual') {
                return studio.paymentIndividual || 0;
            } else {
                const numClients = session.numClients || 0;
                // If clients < startCountFrom: use minimum payment
                // If clients >= startCountFrom: multiply clients by payment per client
                if (numClients < studio.startCountFrom) {
                    return studio.minimumPayment;
                } else {
                    return numClients * studio.paymentPerClient;
                }
            }
        }

        // Tab management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            renderAll();
            if (tg) tg.HapticFeedback.impactOccurred('light');
        }

        // Render all
        function renderAll() {
            renderDashboardStats();
            renderRecentSessions();
            renderStudios();
            renderSessions();
            updateStudioDropdowns();
        }

        // Render dashboard stats
        function renderDashboardStats() {
            const container = document.getElementById('dashboardStats');
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.totalSessions}</div>
                    <div class="stat-label">${t('statSessions')}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.totalAttendees}</div>
                    <div class="stat-label">${t('statAttendees')}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">‚Çæ${stats.paidRevenue.toFixed(2)}</div>
                    <div class="stat-label">${t('statPaid')}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">‚Çæ${stats.pendingRevenue.toFixed(2)}</div>
                    <div class="stat-label">${t('statPending')}</div>
                </div>
            `;
        }

        // Render recent sessions
        function renderRecentSessions() {
            const container = document.getElementById('recentSessions');
            const recent = sessions.slice(-5).reverse();
            
            if (recent.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div>${t('emptySessions')}</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = recent.map(session => {
                const studio = studios.find(s => s.id === session.studioId);
                const payment = calculatePayment(session, studio);
                
                return `
                    <div class="session-item">
                        <div class="session-header">
                            <div class="session-title">${studio ? studio.name : 'Unknown'}</div>
                            <div class="session-amount">‚Çæ${payment.toFixed(2)}</div>
                        </div>
                        <div class="session-info">
                            <div>üìÖ ${session.date} ${t('at')} ${session.time}</div>
                            <div>üë§ ${session.coachName}</div>
                            <div>
                                <span class="badge ${session.sessionType === 'group' ? 'badge-group' : 'badge-individual'}">${t(session.sessionType)}</span>
                                <span class="badge ${session.paid ? 'badge-success' : 'badge-warning'}">${session.paid ? t('paid') : t('pending')}</span>
                                ${session.sessionType === 'group' ? `<span>${session.numClients} ${t('clients')}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render studios
        function renderStudios() {
            const container = document.getElementById('studiosList');
            
            if (studios.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">üè¢</div>
                            <div>${t('emptyStudios')}</div>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = studios.map(studio => `
                <div class="studio-item" style="border-left-color: ${studio.color}">
                    <div class="studio-name">üè¢ ${studio.name}</div>
                    <div class="studio-info">
                        <div>üí∞ ${t('labelMinPayment')}: ‚Çæ${studio.minimumPayment}</div>
                        <div>üë• ${t('labelPaymentPerClient')}: ‚Çæ${studio.paymentPerClient}</div>
                        <div>üî¢ ${t('labelStartCount')}: ${studio.startCountFrom}</div>
                        <div>üë§ ${t('labelIndividual')}: ‚Çæ${studio.paymentIndividual || 0}</div>
                    </div>
                    <div class="action-buttons">
                        <button class="icon-btn" onclick="editStudio(${studio.id})">${t('btnEdit')}</button>
                        <button class="icon-btn danger" onclick="deleteStudio(${studio.id})">${t('btnDelete')}</button>
                    </div>
                </div>
            `).join('');
        }

        // Render sessions
        function renderSessions() {
            const container = document.getElementById('sessionsList');
            
            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">üèãÔ∏è</div>
                            <div>${t('emptySessions')}</div>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = sessions.slice().reverse().map(session => {
                const studio = studios.find(s => s.id === session.studioId);
                const payment = calculatePayment(session, studio);
                
                return `
                    <div class="session-item">
                        <div class="session-header">
                            <div class="session-title">${studio ? studio.name : 'Unknown'}</div>
                            <div class="session-amount">‚Çæ${payment.toFixed(2)}</div>
                        </div>
                        <div class="session-info">
                            <div>üìÖ ${session.date} ${t('at')} ${session.time}</div>
                            <div>üë§ ${session.coachName}</div>
                            <div>
                                <span class="badge ${session.sessionType === 'group' ? 'badge-group' : 'badge-individual'}">${t(session.sessionType)}</span>
                                <span class="badge ${session.paid ? 'badge-success' : 'badge-warning'}">${session.paid ? t('paid') : t('pending')}</span>
                                ${session.sessionType === 'group' ? `<span>${session.numClients} ${t('clients')}</span>` : ''}
                            </div>
                        </div>
                        <div class="action-buttons">
                            ${!session.paid ? `<button class="icon-btn" onclick="markPaid(${session.id})">${t('btnMarkPaid')}</button>` : ''}
                            <button class="icon-btn" onclick="editSession(${session.id})">${t('btnEdit')}</button>
                            <button class="icon-btn danger" onclick="deleteSession(${session.id})">${t('btnDelete')}</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update studio dropdowns
        function updateStudioDropdowns() {
            const sessionStudio = document.getElementById('sessionStudio');
            const filterStudio = document.getElementById('filterStudio');
            
            const options = studios.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            
            sessionStudio.innerHTML = options || '<option value="">No studios available</option>';
            filterStudio.innerHTML = `<option value="">${t('allStudios')}</option>` + options;
        }

        // Studio modal
        function openStudioModal(studioId = null) {
            if (studioId) {
                const studio = studios.find(s => s.id === studioId);
                document.getElementById('studioModalTitle').textContent = t('modalEditStudio');
                document.getElementById('studioId').value = studio.id;
                document.getElementById('studioName').value = studio.name;
                document.getElementById('studioMinPayment').value = studio.minimumPayment;
                document.getElementById('studioPaymentPerClient').value = studio.paymentPerClient;
                document.getElementById('studioStartCount').value = studio.startCountFrom;
                document.getElementById('studioIndividual').value = studio.paymentIndividual || 0;
                document.getElementById('studioColor').value = studio.color;
            } else {
                document.getElementById('studioModalTitle').textContent = t('modalAddStudio');
                document.getElementById('studioForm').reset();
                document.getElementById('studioId').value = '';
                document.getElementById('studioColor').value = '#3390ec';
            }
            document.getElementById('studioModal').classList.add('active');
            if (tg) tg.HapticFeedback.impactOccurred('light');
        }

        function closeStudioModal() {
            document.getElementById('studioModal').classList.remove('active');
        }

        function saveStudio(e) {
            e.preventDefault();
            
            const id = document.getElementById('studioId').value;
            const studioData = {
                id: id ? parseInt(id) : Date.now(),
                name: document.getElementById('studioName').value,
                minimumPayment: parseFloat(document.getElementById('studioMinPayment').value),
                paymentPerClient: parseFloat(document.getElementById('studioPaymentPerClient').value),
                startCountFrom: parseInt(document.getElementById('studioStartCount').value),
                paymentIndividual: parseFloat(document.getElementById('studioIndividual').value) || 0,
                color: document.getElementById('studioColor').value
            };

            if (id) {
                const index = studios.findIndex(s => s.id === parseInt(id));
                studios[index] = studioData;
            } else {
                studios.push(studioData);
            }

            saveStudios(studios);
            closeStudioModal();
            loadData();
            
            if (tg) {
                tg.showAlert(t('studioSaved'));
                tg.HapticFeedback.notificationOccurred('success');
            }
        }

        function editStudio(id) {
            openStudioModal(id);
        }

        function deleteStudio(id) {
            if (confirm(t('confirmDelete'))) {
                studios = studios.filter(s => s.id !== id);
                sessions = sessions.filter(s => s.studioId !== id);
                saveStudios(studios);
                saveSessions(sessions);
                loadData();
                
                if (tg) tg.HapticFeedback.notificationOccurred('success');
            }
        }

        // Session modal
        function openSessionModal(sessionId = null) {
            if (studios.length === 0) {
                if (tg) {
                    tg.showAlert('Please add a studio first!');
                } else {
                    alert('Please add a studio first!');
                }
                return;
            }

            if (sessionId) {
                const session = sessions.find(s => s.id === sessionId);
                document.getElementById('sessionModalTitle').textContent = t('modalEditSession');
                document.getElementById('sessionId').value = session.id;
                document.getElementById('sessionStudio').value = session.studioId;
                document.getElementById('sessionType').value = session.sessionType;
                document.getElementById('sessionDate').value = session.date;
                document.getElementById('sessionTime').value = session.time;
                document.getElementById('sessionClients').value = session.numClients || 1;
                document.getElementById('sessionCoach').value = session.coachName;
                toggleClientsField();
                updatePaymentPreview();
            } else {
                document.getElementById('sessionModalTitle').textContent = t('modalAddSession');
                document.getElementById('sessionForm').reset();
                document.getElementById('sessionId').value = '';
                document.getElementById('sessionDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('sessionTime').value = '10:00';
                document.getElementById('sessionCoach').value = tg?.initDataUnsafe?.user?.first_name || 'Coach';
                document.getElementById('sessionType').value = 'group';
                document.getElementById('sessionClients').value = 1;
                toggleClientsField();
                updatePaymentPreview();
            }
            
            document.getElementById('sessionModal').classList.add('active');
            if (tg) tg.HapticFeedback.impactOccurred('light');
        }

        function closeSessionModal() {
            document.getElementById('sessionModal').classList.remove('active');
        }

        function toggleClientsField() {
            const sessionType = document.getElementById('sessionType').value;
            const clientsGroup = document.getElementById('clientsGroup');
            clientsGroup.style.display = sessionType === 'group' ? 'block' : 'none';
            updatePaymentPreview();
        }

        function updatePaymentPreview() {
            const studioId = parseInt(document.getElementById('sessionStudio').value);
            const sessionType = document.getElementById('sessionType').value;
            const numClients = parseInt(document.getElementById('sessionClients').value) || 1;
            
            const studio = studios.find(s => s.id === studioId);
            if (!studio) return;

            const preview = document.getElementById('paymentPreview');
            let payment = 0;
            let text = '';

            if (sessionType === 'individual') {
                payment = studio.paymentIndividual || 0;
                text = t('individual');
            } else {
                // If clients < startCountFrom: minimum payment
                // If clients >= startCountFrom: clients √ó payment per client
                if (numClients < studio.startCountFrom) {
                    payment = studio.minimumPayment;
                    text = `${t('labelMinPayment')}`;
                } else {
                    payment = numClients * studio.paymentPerClient;
                    text = `${numClients} √ó ‚Çæ${studio.paymentPerClient}`;
                }
            }
            
            preview.innerHTML = `
                <div class="payment-preview">
                    <div class="payment-preview-amount">‚Çæ${payment.toFixed(2)}</div>
                    <div class="payment-preview-text">${text}</div>
                </div>
            `;
            preview.style.display = 'block';
        }

        function saveSession(e) {
            e.preventDefault();
            
            const id = document.getElementById('sessionId').value;
            const sessionData = {
                id: id ? parseInt(id) : Date.now(),
                studioId: parseInt(document.getElementById('sessionStudio').value),
                sessionType: document.getElementById('sessionType').value,
                date: document.getElementById('sessionDate').value,
                time: document.getElementById('sessionTime').value,
                numClients: document.getElementById('sessionType').value === 'group' ? parseInt(document.getElementById('sessionClients').value) : 1,
                coachName: document.getElementById('sessionCoach').value,
                paid: id ? sessions.find(s => s.id === parseInt(id)).paid : false
            };

            if (id) {
                const index = sessions.findIndex(s => s.id === parseInt(id));
                sessions[index] = sessionData;
            } else {
                sessions.push(sessionData);
            }

            saveSessions(sessions);
            closeSessionModal();
            loadData();
            
            if (tg) {
                tg.showAlert(t('sessionSaved'));
                tg.HapticFeedback.notificationOccurred('success');
            }
        }

        function editSession(id) {
            openSessionModal(id);
        }

        function deleteSession(id) {
            if (confirm(t('confirmDelete'))) {
                sessions = sessions.filter(s => s.id !== id);
                saveSessions(sessions);
                loadData();
                
                if (tg) tg.HapticFeedback.notificationOccurred('success');
            }
        }

        function markPaid(id) {
            const session = sessions.find(s => s.id === id);
            if (session) {
                session.paid = true;
                saveSessions(sessions);
                loadData();
                
                if (tg) tg.HapticFeedback.notificationOccurred('success');
            }
        }

        // Filter statistics
        function applyFilters() {
            const studioId = document.getElementById('filterStudio').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;

            let filtered = sessions;

            if (studioId) {
                filtered = filtered.filter(s => s.studioId === parseInt(studioId));
            }

            if (dateFrom) {
                filtered = filtered.filter(s => s.date >= dateFrom);
            }

            if (dateTo) {
                filtered = filtered.filter(s => s.date <= dateTo);
            }

            const paidFiltered = filtered.filter(s => s.paid);
            const pendingFiltered = filtered.filter(s => !s.paid);

            const paidRevenue = paidFiltered.reduce((sum, s) => {
                const studio = studios.find(st => st.id === s.studioId);
                return sum + calculatePayment(s, studio);
            }, 0);

            const pendingRevenue = pendingFiltered.reduce((sum, s) => {
                const studio = studios.find(st => st.id === s.studioId);
                return sum + calculatePayment(s, studio);
            }, 0);

            filteredStats = {
                totalSessions: filtered.length,
                totalAttendees: filtered.reduce((sum, s) => sum + (s.numClients || 0), 0),
                paidRevenue,
                pendingRevenue
            };

            renderFilteredStats();
            if (tg) tg.HapticFeedback.impactOccurred('light');
        }

        function renderFilteredStats() {
            const container = document.getElementById('filteredStats');
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${filteredStats.totalSessions || 0}</div>
                    <div class="stat-label">${t('statSessions')}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${filteredStats.totalAttendees || 0}</div>
                    <div class="stat-label">${t('statAttendees')}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">‚Çæ${(filteredStats.paidRevenue || 0).toFixed(2)}</div>
                    <div class="stat-label">${t('statPaid')}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">‚Çæ${(filteredStats.pendingRevenue || 0).toFixed(2)}</div>
                    <div class="stat-label">${t('statPending')}</div>
                </div>
            `;
        }

        // Export/Import/Clear functions
        async function exportData() {
            const data = {
                studios,
                sessions,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            const fileName = `stretch-studio-backup-${Date.now()}.json`;
            
            // === iOS/MOBILE: Use Web Share API with File ===
            if (navigator.share && navigator.canShare) {
                try {
                    // Create a File object (works on iOS!)
                    const file = new File([jsonString], fileName, {
                        type: 'application/json'
                    });
                    
                    // Check if we can share files
                    if (navigator.canShare({ files: [file] })) {
                        // Share the actual file - iOS will show share sheet!
                        await navigator.share({
                            files: [file],
                            title: 'Stretch Studio Backup',
                            text: 'Backup data from Stretch Studio Manager'
                        });
                        
                        if (tg) {
                            tg.HapticFeedback.notificationOccurred('success');
                        }
                        return;
                    }
                } catch (err) {
                    if (err.name === 'AbortError') {
                        // User cancelled share - that's ok
                        return;
                    }
                    console.log('Web Share API failed, trying fallback:', err);
                }
            }
            
            // === DESKTOP: File System Access API ===
            if ('showSaveFilePicker' in window && !tg) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: fileName,
                        types: [{
                            description: 'JSON Files',
                            accept: {'application/json': ['.json']}
                        }]
                    });
                    
                    const writable = await handle.createWritable();
                    await writable.write(jsonString);
                    await writable.close();
                    
                    alert(t('exportSuccess'));
                    return;
                } catch (err) {
                    if (err.name === 'AbortError') {
                        return;
                    }
                    console.log('Save picker not available, using fallback');
                }
            }
            
            // === FALLBACK: Create data URI and prompt user ===
            // This is last resort for browsers that don't support file sharing
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(jsonString);
            const a = document.createElement('a');
            a.href = dataUri;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            if (tg) {
                tg.showAlert(t('exportSuccess'));
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                alert(t('exportSuccess'));
            }
        }

        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    studios = data.studios || [];
                    sessions = data.sessions || [];
                    saveStudios(studios);
                    saveSessions(sessions);
                    loadData();
                    
                    if (tg) {
                        tg.showAlert(t('importSuccess'));
                        tg.HapticFeedback.notificationOccurred('success');
                    } else {
                        alert(t('importSuccess'));
                    }
                } catch (error) {
                    if (tg) {
                        tg.showAlert('Error: ' + error.message);
                        tg.HapticFeedback.notificationOccurred('error');
                    } else {
                        alert('Error: ' + error.message);
                    }
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm(t('confirmClearAll'))) {
                studios = [];
                sessions = [];
                saveStudios(studios);
                saveSessions(sessions);
                loadData();
                
                if (tg) {
                    tg.showAlert(t('clearSuccess'));
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    alert(t('clearSuccess'));
                }
            }
        }

        function updateDataStatsInfo() {
            const info = document.getElementById('dataStatsInfo');
            const dataSize = JSON.stringify({studios, sessions}).length;
            info.innerHTML = `
                Studios: ${studios.length}<br>
                Sessions: ${sessions.length}<br>
                Storage: ~${Math.round(dataSize / 1024)} KB
            `;
        }

        // Initialize
        updateLanguage();
        loadData();
    </script>
</body>
</html>
